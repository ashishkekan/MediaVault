{% extends 'base.html' %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <h1 class="font-display text-4xl font-bold text-center mb-10">Upload Files</h1>
    
    <div id="dropzone" class="glass-card rounded-3xl p-16 text-center border-2 border-dashed border-muted hover:border-accent">
        <input type="file" id="fileInput" multiple class="hidden">
        <p class="text-2xl mb-6">Drag & drop or click to select multiple files</p>
        <button onclick="document.getElementById('fileInput').click()" 
                class="btn-accent px-10 py-4 rounded-2xl text-lg">Choose Files</button>
    </div>

    <!-- Progress Container -->
    <div id="progressContainer" class="mt-10 space-y-6"></div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const dropzone = document.getElementById('dropzone');
const fileInput = document.getElementById('fileInput');
const progressContainer = document.getElementById('progressContainer');

dropzone.addEventListener('click', () => fileInput.click());
dropzone.addEventListener('dragover', e => { e.preventDefault(); dropzone.classList.add('border-accent'); });
dropzone.addEventListener('dragleave', () => dropzone.classList.remove('border-accent'));
dropzone.addEventListener('drop', e => {
    e.preventDefault();
    handleFiles(e.dataTransfer.files);
});

fileInput.addEventListener('change', e => handleFiles(e.target.files));

function handleFiles(files) {
    Array.from(files).forEach(file => uploadFile(file));
}

async function uploadFile(file) {
    const div = document.createElement('div');
    div.className = 'glass-card rounded-2xl p-4';
    div.innerHTML = `
        <div class="flex justify-between mb-2">
            <span class="truncate">${file.name}</span>
            <span id="percent-${file.name}" class="text-accent">0%</span>
        </div>
        <div class="progress-bar h-2 bg-muted rounded-full overflow-hidden">
            <div id="bar-${file.name}" class="progress-fill h-full w-0 transition-all"></div>
        </div>
    `;
    progressContainer.appendChild(div);

    const formData = new FormData();
    formData.append('file', file);
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

    const xhr = new XMLHttpRequest();
    xhr.open('POST', "{% url 'upload' %}", true);
    
    xhr.upload.onprogress = e => {
        if (e.lengthComputable) {
            const percent = Math.round((e.loaded / e.total) * 100);
            document.getElementById(`bar-${file.name}`).style.width = percent + '%';
            document.getElementById(`percent-${file.name}`).textContent = percent + '%';
        }
    };
    
    xhr.onload = () => {
        if (xhr.status === 200) {
            div.classList.add('border-green-500');
        } else {
            div.classList.add('border-red-500');
        }
    };
    
    xhr.send(formData);
}
</script>
{% endblock %}